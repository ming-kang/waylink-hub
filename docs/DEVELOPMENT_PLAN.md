# é©¿è”ç«™åç«¯å¼€å‘è®¡åˆ’

> æœ€åæ›´æ–°ï¼š2026-01-20
> çŠ¶æ€ï¼šâœ… **å…¨éƒ¨å®Œæˆï¼ˆç¡¬ä»¶APIå·²æ›´æ–°ï¼‰**

## é¡¹ç›®æ¦‚è¿°

**é©¿è”ç«™ (WaylinkHub)** - æ™ºæ…§å…¬äº¤ç«™é¡¹ç›®åç«¯å¼€å‘è®¡åˆ’

| å±‚çº§ | æŠ€æœ¯é€‰å‹ |
|-----|---------|
| Webæ¡†æ¶ | Python + Django + Django REST Framework |
| æ•°æ®åº“ | SQLiteï¼ˆå¼€å‘ï¼‰/ PostgreSQLï¼ˆç”Ÿäº§ï¼‰ |
| è®¤è¯ | è´¦å·å¯†ç  + JWT |
| éƒ¨ç½² | VPS (Linux + Gunicorn + Nginx) |

---

## è¿›åº¦æ¦‚è§ˆ

| é˜¶æ®µ | çŠ¶æ€ | å®Œæˆåº¦ |
|-----|------|--------|
| 1. é¡¹ç›®åˆå§‹åŒ–ä¸åŸºç¡€é…ç½® | âœ… å·²å®Œæˆ | 100% |
| 2. ç”¨æˆ·è®¤è¯æ¨¡å— | âœ… å·²å®Œæˆ | 100% |
| 3. å‚¨ç‰©æŸœç®¡ç†æ¨¡å— | âœ… å·²å®Œæˆ | 100% |
| 4. è®¢å•æ¨¡å— | âœ… å·²å®Œæˆ | 100% |
| 5. è®¾å¤‡é€šä¿¡æ¨¡å— | âœ… å·²å®Œæˆ | 100% |
| 6. è¿ç»´ç®¡ç†API | âœ… å·²å®Œæˆ | 100% |
| 7. APIæ–‡æ¡£ç¼–å†™ | âœ… å·²å®Œæˆ | 100% |
| 8. éƒ¨ç½²é…ç½®ä¸æµ‹è¯• | âœ… å·²å®Œæˆ | 100% |

**æ€»ä½“è¿›åº¦ï¼š8/8ï¼ˆ100%ï¼‰** ğŸ‰

---

## é¡¹ç›®æ–‡ä»¶ç»“æ„

```
WaylinkHub/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ manage.py
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ gunicorn.conf.py              # Gunicorné…ç½®
â”‚   â”œâ”€â”€ waylink/
â”‚   â”‚   â”œâ”€â”€ settings.py               # å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ settings_production.py    # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”‚   â””â”€â”€ urls.py
â”‚   â””â”€â”€ apps/
â”‚       â”œâ”€â”€ users/                    # ç”¨æˆ·è®¤è¯æ¨¡å—
â”‚       â”œâ”€â”€ cabinets/                 # å‚¨ç‰©æŸœæ¨¡å—
â”‚       â”œâ”€â”€ orders/                   # è®¢å•æ¨¡å—
â”‚       â”œâ”€â”€ devices/                  # ESP32è®¾å¤‡é€šä¿¡
â”‚       â””â”€â”€ operations/               # è¿ç»´ç®¡ç†æ¨¡å—
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ DEVELOPMENT_PLAN.md           # æœ¬å¼€å‘è®¡åˆ’
â”‚   â”œâ”€â”€ DEPLOYMENT.md                 # éƒ¨ç½²æŒ‡å—
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ README.md                 # APIæ¥å£æ–‡æ¡£
â””â”€â”€ CLAUDE.md                         # AIå¼€å‘è§„èŒƒ
```

---

## å¼€å‘é˜¶æ®µ

### 1. é¡¹ç›®åˆå§‹åŒ–ä¸åŸºç¡€é…ç½® âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º Django é¡¹ç›® | `backend/` ç›®å½•ç»“æ„ | âœ… å·²å®Œæˆ |
| å®‰è£…ä¾èµ– | Django, DRF, djangorestframework-simplejwt, django-cors-headers | âœ… å·²å®Œæˆ |
| é…ç½® settings.py | æ•°æ®åº“ã€è·¨åŸŸã€è®¤è¯æ–¹å¼ | âœ… å·²å®Œæˆ |
| åˆ›å»º requirements.txt | ä¾èµ–æ¸…å• | âœ… å·²å®Œæˆ |
| é…ç½®è·¯ç”±æ€»è§ˆ | urls.py è·¯ç”±åˆ†å‘ | âœ… å·²å®Œæˆ |

---

### 2. ç”¨æˆ·è®¤è¯æ¨¡å— âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º users app | ç”¨æˆ·æ¨¡å‹æ‰©å±•ï¼ˆUserProfileï¼‰ | âœ… å·²å®Œæˆ |
| ç”¨æˆ·æ³¨å†Œæ¥å£ | `POST /api/auth/register/` | âœ… å·²å®Œæˆ |
| ç”¨æˆ·ç™»å½•æ¥å£ | `POST /api/auth/login/` è¿”å› JWT | âœ… å·²å®Œæˆ |
| JWT åˆ·æ–°æ¥å£ | `POST /api/auth/token/refresh/` | âœ… å·²å®Œæˆï¼ˆDRFå†…ç½®ï¼‰ |
| å½“å‰ç”¨æˆ·ä¿¡æ¯ | `GET /api/auth/me/` | âœ… å·²å®Œæˆ |
| æµ‹è¯• | æ³¨å†Œã€ç™»å½•ã€è®¤è¯æµç¨‹ | âœ… å·²é€šè¿‡ |

---

### 3. å‚¨ç‰©æŸœç®¡ç†æ¨¡å— âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º cabinets app | - | âœ… å·²å®Œæˆ |
| æŸœå­æ¨¡å‹ | ç¼–å·ã€ä½ç½®ã€å°ºå¯¸ã€çŠ¶æ€ã€è´¹ç‡ | âœ… å·²å®Œæˆ |
| æŸœå­åˆ—è¡¨ | `GET /api/cabinets/` | âœ… å·²å®Œæˆ |
| æŸœå­è¯¦æƒ… | `GET /api/cabinets/{id}/` | âœ… å·²å®Œæˆ |
| æŸœå­çŠ¶æ€ | `GET /api/cabinets/{id}/status/` | âœ… å·²å®Œæˆ |
| å¯ç”¨æŸœå­ç­›é€‰ | æŒ‰ä½ç½®ã€å°ºå¯¸è¿‡æ»¤ç©ºé—²æŸœå­ | âœ… å·²å®Œæˆ |
| æµ‹è¯• | åˆ—è¡¨æŸ¥è¯¢ã€çŠ¶æ€æ›´æ–° | âœ… å·²é€šè¿‡ |

**æµ‹è¯•æ•°æ®**ï¼š
| ç¼–å· | å°ºå¯¸ | ç«™ç‚¹ | ä»·æ ¼ | é”è§’åº¦ | ç‰©å“æ£€æµ‹ |
|-----|------|------|------|--------|---------|
| A001 | å°æŸœ | ç«è½¦ç«™ | 2å…ƒ/æ—¶ | 0-360 | çº¢å¤– |
| A002 | å°æŸœ | ç«è½¦ç«™ | 2å…ƒ/æ—¶ | 0-360 | çº¢å¤– |
| B001 | ä¸­æŸœ | ç«è½¦ç«™ | 3å…ƒ/æ—¶ | 0-360 | çº¢å¤– |
| C001 | å¤§æŸœ | æ±½è½¦ç«™ | 5å…ƒ/æ—¶ | 0-360 | çº¢å¤– |

**æ–°å¢å­—æ®µ**ï¼ˆ2026-01-20ï¼‰ï¼š
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| lock_angle | int | ç”µæœºé”èˆŒè§’åº¦ï¼ˆ0-360åº¦ï¼‰ |
| lock_locked | boolean | ç”µæœºé”æ˜¯å¦é”å®š |
| has_item | boolean | æŸœå†…æ˜¯å¦æœ‰ç‰©å“ |
| item_detected_at | datetime | ç‰©å“æ£€æµ‹æ—¶é—´ |

---

### 4. è®¢å•æ¨¡å— âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º orders app | - | âœ… å·²å®Œæˆ |
| è®¢å•æ¨¡å‹ | ç”¨æˆ·ã€æŸœå­ã€å¼€å§‹/ç»“æŸæ—¶é—´ã€çŠ¶æ€ã€é‡‘é¢ | âœ… å·²å®Œæˆ |
| åˆ›å»ºé¢„çº¦è®¢å• | `POST /api/orders/create/` | âœ… å·²å®Œæˆ |
| æˆ‘çš„è®¢å•åˆ—è¡¨ | `GET /api/orders/my/` | âœ… å·²å®Œæˆ |
| è®¢å•è¯¦æƒ… | `GET /api/orders/{id}/` | âœ… å·²å®Œæˆ |
| è®¢å•æ”¯ä»˜ | `POST /api/orders/{id}/pay/` | âœ… å·²å®Œæˆ |
| ç»­è´¹æ¥å£ | `POST /api/orders/{id}/extend/` | âœ… å·²å®Œæˆ |
| å–æ¶ˆè®¢å• | `POST /api/orders/{id}/cancel/` | âœ… å·²å®Œæˆ |
| æµ‹è¯• | è®¢å•CRUDã€çŠ¶æ€æµè½¬ | âœ… å·²é€šè¿‡ |

**è®¢å•çŠ¶æ€æµè½¬**ï¼š
```
å¾…æ”¯ä»˜(pending) â†’ å·²é¢„çº¦(paid) â†’ ä½¿ç”¨ä¸­(in_use) â†’ å·²å®Œæˆ(completed)
                 â†’ å·²å–æ¶ˆ(cancelled)          â†’ é€¾æœŸæœªå–(overdue)
```

**æµ‹è¯•æ•°æ®**ï¼š
| ç”¨æˆ· | ä½™é¢ | è®¢å•å· | æŸœå­ | çŠ¶æ€ | é‡‘é¢ | å–ä»¶ç  |
|-----|------|--------|------|------|------|--------|
| testuser | 88å…ƒ | O2026... | B001 | å·²é¢„çº¦ | 12å…ƒ | 578674 |

---

### 5. è®¾å¤‡é€šä¿¡æ¨¡å—ï¼ˆESP32å¯¹æ¥ï¼‰âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º devices app | - | âœ… å·²å®Œæˆ |
| è®¾å¤‡æ¨¡å‹ | è®¾å¤‡IDã€ç«™ç‚¹ã€åœ¨çº¿çŠ¶æ€ã€æŸœå­ç»‘å®š | âœ… å·²å®Œæˆ |
| è®¾å¤‡æ—¥å¿—æ¨¡å‹ | å¿ƒè·³ã€å¼€æŸœã€çŠ¶æ€å˜æ›´è®°å½• | âœ… å·²å®Œæˆ |
| å¿ƒè·³ä¸ŠæŠ¥æ¥å£ | `POST /api/devices/heartbeat/` | âœ… å·²å®Œæˆ |
| çŠ¶æ€ä¸ŠæŠ¥æ¥å£ | `POST /api/devices/status/` | âœ… å·²å®Œæˆ |
| å¼€æŸœæŒ‡ä»¤æ¥å£ | `POST /api/devices/{id}/open/` | âœ… å·²å®Œæˆ |
| æ‰«ç å¼€æŸœæ¥å£ | `POST /api/devices/open/by-code/` | âœ… å·²å®Œæˆ |
| è®¾å¤‡æ—¥å¿—æŸ¥è¯¢ | `GET /api/devices/{id}/logs/` | âœ… å·²å®Œæˆ |
| è®¾å¤‡ç®¡ç†æ¥å£ | `GET /api/devices/manage/` | âœ… å·²å®Œæˆ |
| å®‰å…¨éªŒè¯ | APIå¯†é’¥è®¤è¯ | âœ… å·²å®Œæˆ |
| çŠ¶æ€æŸ¥è¯¢è½®è¯¢ | `GET /api/devices/status/query/{id}/` | âœ… å·²å®Œæˆ |
| ç®¡ç†å‘˜æŸ¥è¯¢æŸœå­ | `GET /api/devices/query/{id}/` | âœ… å·²å®Œæˆ |
| æµ‹è¯• | å¿ƒè·³ã€å¼€æŸœã€çŠ¶æ€ä¸ŠæŠ¥ | âœ… å·²é€šè¿‡ |

**ESP32 å¯¹æ¥æµç¨‹**ï¼š
```
ESP32 â†’ POST /api/devices/heartbeat/ (X-API-Key) â†’ åç«¯
åç«¯ â† å¿ƒè·³å“åº” (status: online)

ESP32 â†’ GET /api/devices/{id}/open/ (è½®è¯¢) â†’ åç«¯
åç«¯ â† å¼€æŸœæŒ‡ä»¤æˆ– "none"

ESP32 â†’ GET /api/devices/status/query/{id}/ (è½®è¯¢) â†’ åç«¯
åç«¯ â† æŸ¥è¯¢æŒ‡ä»¤æˆ– "none"

ESP32 â†’ POST /api/devices/status/ â†’ åç«¯
    ä¸ŠæŠ¥: door, lock_angle, lock_locked, has_item
```

**2026-01-20 ç¡¬ä»¶APIæ›´æ–°** - æ–°å¢ä¼ æ„Ÿå™¨çŠ¶æ€ä¸ŠæŠ¥ï¼š
- æŸœé—¨çŠ¶æ€ `door`: true=å…³é—­/false=å¼€å¯ï¼ˆçº¢å¤–è·ç¦»ä¼ æ„Ÿå™¨ï¼‰
- ç”µæœºé”è§’åº¦ `lock_angle`: 0-360åº¦ï¼ˆæ­¥è¿›ç”µæœºç¼–ç å™¨ï¼‰
- ç‰©å“æ£€æµ‹ `has_item`: true=æœ‰/false=æ— ï¼ˆçº¢å¤–å¯¹å°„ä¼ æ„Ÿå™¨ï¼‰
- æœåŠ¡å™¨ä¸»åŠ¨æŸ¥è¯¢: `GET /api/devices/query/{id}/`

**æµ‹è¯•æ•°æ®**ï¼š
| è®¾å¤‡ID | ç«™ç‚¹ | ç»‘å®šæŸœå­ | APIå¯†é’¥ |
|--------|------|---------|---------|
| ESP32_001 | ç«è½¦ç«™ | A001, A002, B001 | esp32_test_key_001 |

---

### 6. è¿ç»´ç®¡ç†API âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| åˆ›å»º operations app | - | âœ… å·²å®Œæˆ |
| å¥åº·æ£€æŸ¥ | `GET /api/admin/health/` | âœ… å·²å®Œæˆ |
| ä»ªè¡¨ç›˜ç»Ÿè®¡ | `GET /api/admin/stats/` | âœ… å·²å®Œæˆ |
| æ”¶å…¥ç»Ÿè®¡ | `GET /api/admin/revenue/` | âœ… å·²å®Œæˆ |
| æ‰€æœ‰è®¢å• | `GET /api/admin/orders/` | âœ… å·²å®Œæˆ |
| æŸœå­ç®¡ç† | `GET/PUT /api/admin/cabinets/` | âœ… å·²å®Œæˆ |
| è®¾å¤‡ç®¡ç† | `GET/PUT /api/admin/devices/` | âœ… å·²å®Œæˆ |
| æ•…éšœé¢„è­¦ | `GET /api/admin/alerts/` | âœ… å·²å®Œæˆ |
| æµ‹è¯• | ç»Ÿè®¡æ¥å£ã€ç®¡ç†æ“ä½œ | âœ… å·²é€šè¿‡ |

**æ•…éšœé¢„è­¦ç±»å‹**ï¼š
| ç±»å‹ | çº§åˆ« | è¯´æ˜ |
|-----|------|------|
| device_offline | warning | è®¾å¤‡ç¦»çº¿ |
| low_battery | warning | ç”µé‡ä½ï¼ˆ<20%ï¼‰ |
| order_overdue | warning | è®¢å•é€¾æœŸ |
| cabinet_maintenance | info | æŸœå­ç»´æŠ¤ä¸­ |

---

### 7. APIæ–‡æ¡£ç¼–å†™ âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| APIæ–‡æ¡£ | `docs/api/README.md` | âœ… å·²å®Œæˆ |
| éƒ¨ç½²æŒ‡å— | `docs/DEPLOYMENT.md` | âœ… å·²å®Œæˆ |

**APIæ–‡æ¡£åŒ…å«**ï¼š
- æ¦‚è¿°ä¸ç»Ÿä¸€å“åº”æ ¼å¼
- è®¤è¯æ¨¡å—ï¼ˆæ³¨å†Œã€ç™»å½•ã€åˆ·æ–°Tokenï¼‰
- å‚¨ç‰©æŸœæ¨¡å—ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€çŠ¶æ€ï¼‰
- è®¢å•æ¨¡å—ï¼ˆåˆ›å»ºã€æ”¯ä»˜ã€ç»­è´¹ã€å–æ¶ˆï¼‰
- è®¾å¤‡é€šä¿¡æ¨¡å—ï¼ˆå¿ƒè·³ã€çŠ¶æ€ä¸ŠæŠ¥ã€å¼€æŸœã€ä¼ æ„Ÿå™¨çŠ¶æ€ï¼‰
- è¿ç»´ç®¡ç†æ¨¡å—ï¼ˆç»Ÿè®¡ã€æ”¶å…¥ã€é¢„è­¦ã€å¥åº·æ£€æŸ¥ï¼‰
- é”™è¯¯ç è¯´æ˜
- ç¡¬ä»¶ä¼ æ„Ÿå™¨çŠ¶æ€è¯´æ˜

---

### 8. éƒ¨ç½²é…ç½®ä¸æµ‹è¯• âœ…
| ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|
| ç”Ÿäº§é…ç½® | `settings_production.py` | âœ… å·²å®Œæˆ |
| Gunicorné…ç½® | `gunicorn.conf.py` | âœ… å·²å®Œæˆ |
| Nginxé…ç½® | `nginx.conf` | âœ… å·²å®Œæˆ |
| éƒ¨ç½²æŒ‡å— | `docs/DEPLOYMENT.md` | âœ… å·²å®Œæˆ |

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
- PostgreSQL æ•°æ®åº“è¿æ¥
- å®‰å…¨è®¾ç½®ï¼ˆSSLé‡å®šå‘ã€Cookieå®‰å…¨ï¼‰
- Systemd æœåŠ¡é…ç½®
- Let's Encrypt SSL é…ç½®
- æ•°æ®åº“å¤‡ä»½ç­–ç•¥

---

## å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
cd backend
python manage.py runserver
```

è®¿é—® `http://localhost:8000/api/cabinets/` æµ‹è¯• APIã€‚

---

## å›¢é˜Ÿåˆ†å·¥

| æˆå‘˜ | è´Ÿè´£æ–¹å‘ |
|-----|---------|
| æ–¹æ˜åº· | åç«¯å¼€å‘ |
| é™ˆå“ | è½¯ç¡¬ä»¶é›†æˆï¼ˆESP32ï¼‰ |
| é™ˆé¹å®‡ | å‰ç«¯è®¾è®¡ + ç”¨æˆ·ç ”ç©¶ |

---

## é¡¹ç›®å®Œæˆæ—¶é—´çº¿

| æ—¥æœŸ | å®Œæˆå†…å®¹ |
|-----|---------|
| 2025-01-19 | é¡¹ç›®åˆå§‹åŒ–ã€ç”¨æˆ·è®¤è¯ã€å‚¨ç‰©æŸœæ¨¡å— |
| 2025-01-19 | è®¢å•æ¨¡å—ã€è®¾å¤‡é€šä¿¡æ¨¡å— |
| 2025-01-19 | è¿ç»´ç®¡ç†APIã€APIæ–‡æ¡£ã€éƒ¨ç½²é…ç½® |
| 2026-01-20 | ç¡¬ä»¶APIæ›´æ–°ï¼šä¼ æ„Ÿå™¨çŠ¶æ€ä¸ŠæŠ¥ã€æœåŠ¡å™¨æŸ¥è¯¢æ¥å£ |

**æ€»å¼€å‘æ—¶é—´ï¼šçº¦1å¤© + 1æ¬¡åŠŸèƒ½æ›´æ–°**
